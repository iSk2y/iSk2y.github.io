<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>xiunoBBS正方插件开发记录 | iSk2y's Note</title><meta name="description" content="xiunoBBS正方插件开发记录"><meta name="keywords" content="PHP,xiuno BBS"><meta name="author" content="iSk2y"><meta name="copyright" content="iSk2y"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://isk2y.github.io/2018/12/18/xiunoBBS-plugin-zfauth-note/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="xiunoBBS正方插件开发记录"><meta name="twitter:description" content="xiunoBBS正方插件开发记录"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="xiunoBBS正方插件开发记录"><meta property="og:url" content="http://isk2y.github.io/2018/12/18/xiunoBBS-plugin-zfauth-note/"><meta property="og:site_name" content="iSk2y's Note"><meta property="og:description" content="xiunoBBS正方插件开发记录"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="H5唤起APP进行分享的尝试" href="http://isk2y.github.io/2019/01/04/h5-via-app-share/"><link rel="next" title="简单解读Xiuno BBS之流程" href="http://isk2y.github.io/2018/12/11/Learn-XiunoBBs-01/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0e34c7227d935e8ca4e5a98cf3bd8629";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://isk2y.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: {"languages":{"author":"作者: iSk2y","link":"链接: http://isk2y.github.io/2018/12/18/xiunoBBS-plugin-zfauth-note/","source":"来源: iSk2y's Note","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  copy_copyright_js: true
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">iSk2y's Note</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/book/"><i class="fa-fw fa fa-book"></i><span> Book</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="http://isk2y.github.io/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/book/"><i class="fa-fw fa fa-book"></i><span> Book</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#正方认证插件"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">正方认证插件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#插件配置信息"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">插件配置信息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#页面添加认证栏"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">页面添加认证栏</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#PC端"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">PC端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#mobile端"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">mobile端</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#添加路由"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">添加路由</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#编写view页面"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">编写view页面</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#编写自己的func内容"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">编写自己的func内容</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#正方扩展表"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">正方扩展表</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#完善路由controller层"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">完善路由controller层</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#流程-amp-逻辑"><span class="toc_mobile_items-number">8.1.</span> <span class="toc_mobile_items-text">流程&amp;逻辑</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#验证码刷新两个函数的实现"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">验证码刷新两个函数的实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#本地存放形式"><span class="toc_mobile_items-number">9.1.</span> <span class="toc_mobile_items-text">本地存放形式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#直接路由访问"><span class="toc_mobile_items-number">9.2.</span> <span class="toc_mobile_items-text">直接路由访问</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#设置校内认证组"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">设置校内认证组</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#最终效果"><span class="toc_mobile_items-number">11.</span> <span class="toc_mobile_items-text">最终效果</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#总结反思"><span class="toc_mobile_items-number">12.</span> <span class="toc_mobile_items-text">总结反思</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#展望"><span class="toc_mobile_items-number">12.1.</span> <span class="toc_mobile_items-text">展望</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#正方认证插件"><span class="toc-number">1.</span> <span class="toc-text">正方认证插件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#插件配置信息"><span class="toc-number">2.</span> <span class="toc-text">插件配置信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#页面添加认证栏"><span class="toc-number">3.</span> <span class="toc-text">页面添加认证栏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PC端"><span class="toc-number">3.1.</span> <span class="toc-text">PC端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mobile端"><span class="toc-number">3.2.</span> <span class="toc-text">mobile端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#添加路由"><span class="toc-number">4.</span> <span class="toc-text">添加路由</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编写view页面"><span class="toc-number">5.</span> <span class="toc-text">编写view页面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编写自己的func内容"><span class="toc-number">6.</span> <span class="toc-text">编写自己的func内容</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#正方扩展表"><span class="toc-number">7.</span> <span class="toc-text">正方扩展表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完善路由controller层"><span class="toc-number">8.</span> <span class="toc-text">完善路由controller层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程-amp-逻辑"><span class="toc-number">8.1.</span> <span class="toc-text">流程&amp;逻辑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#验证码刷新两个函数的实现"><span class="toc-number">9.</span> <span class="toc-text">验证码刷新两个函数的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#本地存放形式"><span class="toc-number">9.1.</span> <span class="toc-text">本地存放形式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#直接路由访问"><span class="toc-number">9.2.</span> <span class="toc-text">直接路由访问</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置校内认证组"><span class="toc-number">10.</span> <span class="toc-text">设置校内认证组</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最终效果"><span class="toc-number">11.</span> <span class="toc-text">最终效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结反思"><span class="toc-number">12.</span> <span class="toc-text">总结反思</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#展望"><span class="toc-number">12.1.</span> <span class="toc-text">展望</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">xiunoBBS正方插件开发记录</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2018-12-18<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-11-14</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/PHP/">PHP</a></span><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="正方认证插件"><a href="#正方认证插件" class="headerlink" title="正方认证插件"></a>正方认证插件</h1><p>基于XiunoBBS开发的正方认证插件</p>
<a id="more"></a>
<blockquote>
<p>PS：开发插件请把DEBUG设置为2，否则是不会及时编译文件到tmp目录下的，具体原因看博文</p>
</blockquote>
<h1 id="插件配置信息"><a href="#插件配置信息" class="headerlink" title="插件配置信息"></a>插件配置信息</h1><blockquote>
<p>conf.json</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"正方认证"</span>,</span><br><span class="line">  <span class="attr">"brief"</span>:<span class="string">"接入正方认证，认证后添加到学生组"</span>,</span><br><span class="line">  <span class="attr">"version"</span>:<span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"bbs_version"</span>:<span class="string">"4.0.4"</span>,</span><br><span class="line">  <span class="attr">"installed"</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">"enable"</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">"hooks_rank"</span>:[],</span><br><span class="line">  <span class="attr">"overwrites_rank"</span>:[],</span><br><span class="line">  <span class="attr">"dependencies"</span>:[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="页面添加认证栏"><a href="#页面添加认证栏" class="headerlink" title="页面添加认证栏"></a>页面添加认证栏</h1><p>先在my页面左侧栏添加一栏 正方认证 ，作为认证的超链接入口。这里要利用<code>my_common_my_thread_after.htm</code>这个hook，具体原因看 <code>view/htm/my.common.template.htm</code>文件。</p>
<h2 id="PC端"><a href="#PC端" class="headerlink" title="PC端"></a>PC端</h2><ol>
<li><p>新建<code>hook/my_common_my_thread_after.htm</code></p>
</li>
<li><p>写入内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;?php echo url('my-zfauth');?&gt;"</span> <span class="attr">class</span>=<span class="string">"list-group-item list-group-item-action"</span> <span class="attr">data-active</span>=<span class="string">"menu-my-zfauth"</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfauth'</span>);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><del>正方认证这几个字直接硬编码了，因为考虑到应该用到的语言项内容不多，暂时就不写lang了，后面有需要再说</del></p>
<p>真香，我还是用了lang（hook文件夹下建立<code>lang_zh_cn_bbs.php</code>）</p>
</li>
</ol>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-463a2f35badadb89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<h2 id="mobile端"><a href="#mobile端" class="headerlink" title="mobile端"></a>mobile端</h2><p>因为是响应式的，但是我也不知为啥代码分开写了，那就还要触发另一个hook</p>
<ol>
<li>新建<code>hook/my_common_mobile_my_thread_after.htm</code></li>
<li>写入内容</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">role</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-secondary"</span> <span class="attr">data-active</span>=<span class="string">"menu-my-zfauth"</span> <span class="attr">href</span>=<span class="string">"&lt;?php echo url('my-zfauth');?&gt;"</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfauth'</span>);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-7787a6a69d3df64f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<blockquote>
<p>PS：消息 是我另外添加的插件</p>
</blockquote>
<p>正方认证的字样已经出现了，但是现在点了肯定是空白的，接下来我们添加路由</p>
<h1 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h1><p>利用<code>my_end.php</code>这个hook</p>
<ol>
<li>新建<code>hook/my_end.php</code></li>
<li>书写内容为</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">exit</span>;</span><br><span class="line"><span class="keyword">elseif</span>($action == <span class="string">'zfauth'</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($method == <span class="string">'GET'</span>) &#123;</span><br><span class="line"></span><br><span class="line">		$active = <span class="string">'zfauth'</span>; <span class="comment">// bootstrap active状态显示</span></span><br><span class="line">		</span><br><span class="line">		$header[<span class="string">'title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line">		$header[<span class="string">'mobile_title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line">		<span class="comment">// view视图部分</span></span><br><span class="line">		<span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/view/htm/my_zfauth.htm'</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">elseif</span>($method == <span class="string">'POST'</span>) &#123;</span><br><span class="line"></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>暂时没有些其他什么逻辑</p>
<h1 id="编写view页面"><a href="#编写view页面" class="headerlink" title="编写view页面"></a>编写view页面</h1><p>然后包含my_zfauth.htm并_include</p>
<blockquote>
<p>plugin/isk2y_zfauth/view/htm/my_zfauth.htm</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">include</span>=<span class="string">"./plugin/isk2y_zfauth/view/htm/my_zfauth.template.htm"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"my_body"</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfauth'</span>);<span class="meta">?&gt;</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'a[data-active="my-zfauth"]'</span>).addClass(<span class="string">'active'</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中模板又使用了my_zfauth.template.htm</p>
<blockquote>
<p>plugin/isk2y_zfauth/view/htm/my_zfauth.template.htm</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">include</span>=<span class="string">"./view/htm/my.common.template.htm"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"my_nav"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav nav-tabs card-header-tabs"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&#123;hook my_nav_notice_before.htm&#125;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link"</span> <span class="attr">href</span>=<span class="string">"&lt;?php echo url("</span><span class="attr">my-zfauth</span>");?&gt;</span>" data-active="my-zfauth"&gt;<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfauth'</span>);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&#123;hook my_nav_notice_after.htm&#125;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'a[data-active="menu-my-zfauth"]'</span>).addClass(<span class="string">'active'</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-b7e9b4218f31e3e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<p>然后经过我不堪入目的前端修改下就凑合这样子吧~~</p>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-a66b43e352d7e237.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<p><img alt="1544862193207" data-src="C:\Users\isk2y\AppData\Roaming\Typora\typora-user-images\1544862193207.png" class="lozad"></p>
<p>修改后的源码</p>
<blockquote>
<p>plugin/isk2y_zfauth/view/htm/my_zfauth.template.htm</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">include</span>=<span class="string">"./plugin/isk2y_zfauth/view/htm/my_zfauth.template.htm"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"my_body"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"zfform"</span> <span class="attr">action</span>=<span class="string">"&lt;?php echo url('my-zfauth');?&gt;"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"zfusername"</span> <span class="attr">class</span>=<span class="string">"col-3 col-form-label text-right"</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfusername'</span>);<span class="meta">?&gt;</span></span>:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-9 col-sm-5 col-xl-4"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"zfusername"</span> <span class="attr">name</span>=<span class="string">"zfusername"</span> <span class="attr">placeholder</span>=<span class="string">"就是你的学号啦！"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"zfpassword"</span> <span class="attr">class</span>=<span class="string">"col-3 col-form-label text-right"</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfpassword'</span>);<span class="meta">?&gt;</span></span>:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-9 col-sm-5 col-xl-4"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"zfpassword"</span> <span class="attr">name</span>=<span class="string">"zfpassword"</span> <span class="attr">placeholder</span>=<span class="string">"盖住屏幕不要给别人看密码!"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row d-flex align-items-center"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"zfvaptcha"</span> <span class="attr">class</span>=<span class="string">"col-3 col-form-label text-right"</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfverifycode'</span>);<span class="meta">?&gt;</span></span>:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-6 col-sm-3 col-xl-2 "</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"zfvaptcha"</span> <span class="attr">name</span>=<span class="string">"zfvcode"</span> <span class="attr">placeholder</span>=<span class="string">"→_→"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-3 col-sm-2 col-xl-1 d-flex justify-content-center"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;?php echo $vcodesrc;?&gt;"</span> <span class="attr">alt</span>=<span class="string">"正方验证码拉取失败~~"</span> <span class="attr">id</span>=<span class="string">"vcode"</span> <span class="attr">onclick</span>=<span class="string">"getVcode()"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group row col-6 col-sm-5 col-xl-4 offset-3"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span> <span class="attr">id</span>=<span class="string">"submit"</span> <span class="attr">data-loading-text</span>=<span class="string">"&lt;?php echo lang('zfauthing');?&gt;..."</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> lang(<span class="string">'zfauth'</span>);<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="编写自己的func内容"><a href="#编写自己的func内容" class="headerlink" title="编写自己的func内容"></a>编写自己的func内容</h1><p>上面的初步工作已经完成，然后就是用PHP去模拟登陆正方了，这边不详细展开如何模拟获取信息的过程了，不属于本文重点内容，不过要吐槽的是 正方真的有点烦！！！！还有总结的几个注意点</p>
<ol>
<li>模拟登陆正方最重要的是 cookie，访问default.aspx和验证码都会检查你的cookie是否存在如果没有就set-cookie给你，所以你得在第一次访问任何一个页面的时候把cookie存下来，下次继续用这个cookie去访问其他页面，这是为了让正方认得你，因为cookie中带有session的辨认符。至于怎么放我思考了两个点<ul>
<li>把cookie作为临时变量，但是你得确保在一次访问脚本中就登录，显然这是不可能的，除非你已经知道用户的密码了，这个当然可以咯</li>
<li>把cookie存放在session里，持久化储存，肯定可以的。但是会消耗session资源而且可能在并发大的时候造成session阻塞。</li>
<li>把cookie设置在你本地，随用随取，但是污染了本地cookie，其实谈不上污染就多一个值嘛~~</li>
</ul>
</li>
<li>正方登陆页面的两个hidden隐藏表单内容，得在先前取到，至于放在哪里？<ul>
<li>放在session里或者其他持久化储存中</li>
<li>放在前端！！把从正方拿到的表单给用户传过去放在前端，这样他下次提交的时候就能拿到了，嘻嘻~~</li>
</ul>
</li>
<li>登陆的302 要跟进，curl别忘记设置。</li>
<li>如果出现访问个人信息页面xsgrxx 出现object move to here，那肯定是你cookie不对了，自己debug下。</li>
<li>记得设置好编码，正方不用utf-8的！！</li>
<li>可以在curl中设置proxy，提高debug效率！首选fiddler。</li>
</ol>
<p>好了，总结正方的内容，下次我肯定不会用PHP写爬虫了！！！打死我也不！！回到Python，一把梭就完了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/utils/simple_html_dom.class.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取正方登陆表单中必要的form元素，并获取到cookie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $url 正方url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getZfinit</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">    $ret = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    $headerArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Referer:'</span> . $url,</span><br><span class="line">    );</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">TRUE</span>);    <span class="comment">//启用时会将头文件的信息作为数据流输出,为了取到cookie</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_NOBODY, <span class="keyword">FALSE</span>);   <span class="comment">//表示需要response body</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER , $headerArr );  <span class="comment">//构造header头部</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">TRUE</span>); <span class="comment">// 将获取到的内容返回，而不是直接输出</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="keyword">FALSE</span>); <span class="comment">//表示不重定向</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">300</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回状态码200 表示正常访问正方成功了</span></span><br><span class="line">    <span class="keyword">if</span> (curl_getinfo($ch, CURLINFO_HTTP_CODE) == <span class="string">'200'</span>) &#123;</span><br><span class="line"></span><br><span class="line">        $view = <span class="keyword">array</span>();</span><br><span class="line">        preg_match_all(<span class="string">'/&lt;input type="hidden" name="__VIEWSTATE" value="([^&lt;&gt;]+)" \/&gt;/'</span>, $result, $view[<span class="string">'state'</span>]); <span class="comment">//获取__VIEWSTATE字段并存到$view数组中</span></span><br><span class="line">        preg_match_all(<span class="string">'/&lt;input type="hidden" name="__VIEWSTATEGENERATOR" value="([^&lt;&gt;]+)" \/&gt;/'</span>, $result, $view[<span class="string">'stategenerator'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 匹配cookie</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/Set-Cookie:[\s+](.*);/iU'</span>,$result,$cookie))&#123;</span><br><span class="line">            <span class="comment">// 判断下当前有没有获取过cookie了 ,如果获取过就别在set了</span></span><br><span class="line"></span><br><span class="line">            header(<span class="string">'Set-Cookie: '</span>.$cookie[<span class="number">1</span>].<span class="string">'; path=/'</span>);</span><br><span class="line">            $ret[<span class="string">'status'</span>] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 想来想去 这个view表单hidden项还是存在session中吧，因为后面还要用到，或者把表单项显示到前端去</span></span><br><span class="line">            <span class="keyword">if</span>(session_status() === <span class="number">1</span>)&#123;</span><br><span class="line">                session_start();</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(session_status() === <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">exit</span>(<span class="string">'会话是被禁用的。请打开session支持'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $_SESSION[<span class="string">'zfview'</span>] = $view;</span><br><span class="line">            session_write_close();</span><br><span class="line"></span><br><span class="line">            $ret[<span class="string">'cookie'</span>] = $cookie[<span class="number">1</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $ret[<span class="string">'status'</span>] = <span class="keyword">false</span>;</span><br><span class="line">            $ret[<span class="string">'reason'</span>] = <span class="string">'match_cookie_failed'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $ret[<span class="string">'status'</span>] = <span class="keyword">false</span>;</span><br><span class="line">        $ret[<span class="string">'reason'</span>] = <span class="string">'open_zf_failed'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    <span class="keyword">return</span> $ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * import！ 确保这个函数在getZfinit后调用，否则cookie取不到相同登陆会失败</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $codeUrl 验证码的url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $cookie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $vcodepath 存放验证码的地方</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getZfVCode</span><span class="params">($codeUrl, $cookie, $vcodepath)</span></span>&#123;</span><br><span class="line">    $getstatus = <span class="keyword">true</span>;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $codeUrl);</span><br><span class="line">    curl_setopt($ch, CURLOPT_COOKIE, $cookie);  <span class="comment">//带cookie访问</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">TRUE</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">TRUE</span>);</span><br><span class="line">    $img = curl_exec($ch);  <span class="comment">//执行curl</span></span><br><span class="line">    <span class="keyword">if</span> (curl_getinfo($ch,CURLINFO_HTTP_CODE) != <span class="string">'200'</span> )&#123;</span><br><span class="line">        $getstatus = <span class="keyword">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($head,$body) = explode(<span class="string">"\r\n\r\n"</span>,$img);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/Set-Cookie:[\s+](.*);/iU'</span>,$head,$cookie))&#123;</span><br><span class="line">            header(<span class="string">'Set-Cookie: '</span>.$cookie[<span class="number">1</span>].<span class="string">'; path=/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    curl_close($ch); <span class="comment">// 要注意关闭curl才能写文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果你不想把验证码下载到本地 可以多加一个路由，将图片展示到该路由上即可，想想怎么改？而且这样cookie也不用写入session了</span></span><br><span class="line">    $fp = fopen($vcodepath.<span class="string">"verifyCode.jpg"</span>,<span class="string">"w"</span>);  <span class="comment">//文件名</span></span><br><span class="line">    fwrite($fp,$body);  <span class="comment">//写入文件</span></span><br><span class="line">    fclose($fp);</span><br><span class="line">    <span class="keyword">return</span> $getstatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取验证码的路由方法，直接echo出来就是图片了，已经设置header</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $codeUrl 正方验证码url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed 拿回验证码的raw数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getZfVcodeRouter</span><span class="params">($codeUrl)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $headerArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Referer:http://自己写正方地址！！'</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'ASP_NET_SessionId'</span>]))&#123;</span><br><span class="line">        $headerArr[] = <span class="string">'Cookie: ASP.NET_SessionId='</span>.$_COOKIE[<span class="string">'ASP_NET_SessionId'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $codeUrl);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">TRUE</span>);    <span class="comment">//表示需要response header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_NOBODY, <span class="keyword">FALSE</span>); <span class="comment">//表示需要response body</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER , $headerArr );  <span class="comment">//构造IP</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">TRUE</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="keyword">FALSE</span>);</span><br><span class="line">    <span class="comment">//curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">120</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    <span class="keyword">if</span> (curl_getinfo($ch,CURLINFO_HTTP_CODE) != <span class="string">'200'</span> )&#123;</span><br><span class="line">        $getstatus = <span class="keyword">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($head,$body) = explode(<span class="string">"\r\n\r\n"</span>,$result);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/Set-Cookie:[\s+](.*);/iU'</span>,$head,$cookie))&#123;</span><br><span class="line">            header(<span class="string">'Set-Cookie: '</span>.$cookie[<span class="number">1</span>].<span class="string">'; path=/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">'Content-Type:image/Gif'</span>);</span><br><span class="line">        $result = $body;</span><br><span class="line">    &#125;</span><br><span class="line">    curl_close($ch); <span class="comment">// 要注意关闭curl才能写文件</span></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $url 正方url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $xh 学号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $pw 密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $code 验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array('status'=&gt; bool, 'data'=&gt; string)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zfLoginPost</span><span class="params">($url, $xh, $pw, $code)</span> </span>&#123;</span><br><span class="line">    $ret = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'status'</span>=&gt;<span class="keyword">false</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(session_status() === <span class="number">1</span>)&#123;</span><br><span class="line">        session_start();</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(session_status() === <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'会话是被禁用的。请打开session支持'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $post=<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'__VIEWSTATE'</span>=&gt;$_SESSION[<span class="string">'zfview'</span>][<span class="string">'state'</span>][<span class="number">1</span>][<span class="number">0</span>],</span><br><span class="line">        <span class="string">'__VIEWSTATEGENERATOR'</span> =&gt;$_SESSION[<span class="string">'zfview'</span>][<span class="string">'stategenerator'</span>][<span class="number">1</span>][<span class="number">0</span>],</span><br><span class="line">        <span class="string">'txtUserName'</span>=&gt;$xh,</span><br><span class="line">        <span class="string">'Textbox1'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">        <span class="string">'TextBox2'</span>=&gt;$pw,</span><br><span class="line">        <span class="string">'txtSecretCode'</span>=&gt;$code,</span><br><span class="line">        <span class="string">'RadioButtonList1'</span>=&gt;iconv(<span class="string">'utf-8'</span>,<span class="string">'gb2312'</span>,<span class="string">'学生'</span>),  <span class="comment">//“学生”的gbk编码</span></span><br><span class="line">        <span class="string">'Button1'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">        <span class="string">'lbLanguage'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">        <span class="string">'hidPdrs'</span>=&gt;<span class="string">''</span>,</span><br><span class="line">        <span class="string">'hidsc'</span>=&gt;<span class="string">''</span></span><br><span class="line">    );</span><br><span class="line">    session_write_close();</span><br><span class="line"></span><br><span class="line">    $post = http_build_query($post);</span><br><span class="line"></span><br><span class="line">    $headerArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Referer: http://自己写正方地址/default2.aspx'</span>,</span><br><span class="line">        <span class="string">'Content-Type: application/x-www-form-urlencoded'</span>,</span><br><span class="line">        <span class="string">'Host: 自己写正方地址'</span>,</span><br><span class="line">        <span class="string">'Origin: http://自己写正方地址'</span>,</span><br><span class="line">        <span class="string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36'</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'ASP_NET_SessionId'</span>]))&#123;</span><br><span class="line">        $headerArr[] = <span class="string">'Cookie: ASP.NET_SessionId='</span>.$_COOKIE[<span class="string">'ASP_NET_SessionId'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); <span class="comment">//不自动输出数据，要echo才行</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>); <span class="comment">//重要，抓取跳转后数据</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER , $headerArr );  <span class="comment">//构造header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_REFERER, $url); <span class="comment">//重要，ASP的302跳转需要referer，可以在Request Headers找到</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $post); <span class="comment">//post提交数据</span></span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    <span class="comment">// 登陆成功后302跳转会到主页，把这个主页记录下</span></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/.*?&lt;a.+"(xsgrxx.aspx\?.*?)".*?&gt;.*?&lt;\/a&gt;.*?/i'</span>,$result,$stuInfoUrl)) &#123;</span><br><span class="line">        session_start();</span><br><span class="line">        $_SESSION[<span class="string">'zf_profileUrl'</span>] = <span class="string">'http://自己写正方地址/'</span>.iconv(<span class="string">'gb2312'</span>,<span class="string">'utf-8//ignore'</span>,$stuInfoUrl[<span class="number">1</span>]);</span><br><span class="line">        session_write_close();</span><br><span class="line">        $ret[<span class="string">'status'</span>] = <span class="keyword">TRUE</span>;</span><br><span class="line">        $ret[<span class="string">'data'</span>] = $result;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">elseif</span> (preg_match(<span class="string">'/alert\(\'(.*?)\'\)/'</span>,$result,$reason))&#123;</span><br><span class="line">        <span class="comment">// 密码错误 或者 验证码错误 会匹配到的</span></span><br><span class="line">        $ret[<span class="string">'data'</span>] = mb_convert_encoding($reason[<span class="number">1</span>],<span class="string">'UTF-8'</span>,<span class="string">'GB2312'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $ret[<span class="string">'data'</span>] = <span class="string">"open_zf_failed"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    curl_close($ch);</span><br><span class="line">    <span class="keyword">return</span> $ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $url 正方url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $xh 学号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $pw 密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $code 验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getZfInfo</span><span class="params">($url, $xh, $pw, $code)</span></span>&#123;</span><br><span class="line">    $ret = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'status'</span>=&gt;<span class="keyword">false</span>,</span><br><span class="line">        <span class="string">'data'</span>=&gt;<span class="string">''</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    $logStatus = zfLoginPost($url, $xh, $pw, $code);</span><br><span class="line">    <span class="keyword">if</span> (!$logStatus[<span class="string">'status'</span>])&#123;</span><br><span class="line"><span class="comment">//        print_r($logStatus);</span></span><br><span class="line"><span class="comment">//        exit;</span></span><br><span class="line">        $logStatus[<span class="string">'data'</span>] === <span class="string">'open_zf_failed'</span> <span class="keyword">AND</span> xn_message(<span class="number">1</span>,lang(<span class="string">'open_zf_failed'</span>));</span><br><span class="line">        <span class="comment">// 前端input按照错误弹出alert 是根据code构造的选择器，看my_zfauth.htm的js代码，</span></span><br><span class="line">        $r = mb_strpos($logStatus[<span class="string">'data'</span>],<span class="string">'验证码'</span>);</span><br><span class="line">        <span class="comment">// 错误在logStatus里匹配返回值了 不写在lang里面了</span></span><br><span class="line">        $r === <span class="keyword">false</span> <span class="keyword">AND</span> xn_message(<span class="string">'zfpassword'</span>,$logStatus[<span class="string">'data'</span>]);</span><br><span class="line">        xn_message(<span class="string">'zfvcode'</span>,$logStatus[<span class="string">'data'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    $headerArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Referer: http://自己写正方地址/xs_main.aspx?'</span>,</span><br><span class="line">        <span class="string">'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'ASP_NET_SessionId'</span>]))&#123;</span><br><span class="line">        $headerArr[] = <span class="string">'Cookie: ASP.NET_SessionId='</span>.$_COOKIE[<span class="string">'ASP_NET_SessionId'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(session_status() === <span class="number">1</span>)&#123;</span><br><span class="line">        session_start();</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(session_status() === <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'会话是被禁用的。请打开session支持'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $_SESSION[<span class="string">'zf_profileUrl'</span>]);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">false</span>);    <span class="comment">//表示需要response header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_NOBODY, <span class="keyword">FALSE</span>); <span class="comment">//表示需要response body</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER , $headerArr );  <span class="comment">//构造header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">TRUE</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="keyword">FALSE</span>);</span><br><span class="line">    <span class="comment">//curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">300</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(curl_getinfo($ch, CURLINFO_HTTP_CODE) != <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="comment">// 正方打开失败</span></span><br><span class="line">        $ret[<span class="string">'data'</span>] = <span class="string">'open_zf_failed'</span>;</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    exit($result);</span></span><br><span class="line">    <span class="comment">/* 删除空白字符 */</span></span><br><span class="line">    $result=preg_replace(<span class="string">"/[\t\n\r]+/"</span>,<span class="string">""</span>,$result);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/.*?(&lt;table class="formlist" width="100%" align="center"&gt;.*?&lt;\/table&gt;).*?/U'</span>,$result,$stuInfoTable))&#123; <span class="comment">//寻找必要信息</span></span><br><span class="line">        <span class="keyword">if</span>($userInfo = parseZfInfo(iconv(<span class="string">'gb2312'</span>,<span class="string">'utf-8'</span>,$stuInfoTable[<span class="number">1</span>])))&#123;</span><br><span class="line">            $ret[<span class="string">'status'</span>] = <span class="keyword">true</span>;</span><br><span class="line">            $ret[<span class="string">'data'</span>] = $userInfo;<span class="comment">// 解析回来的信息</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 个人数据解析失败</span></span><br><span class="line">            $ret[<span class="string">'data'</span>] = <span class="string">'info_not_found'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 没找到必要信息</span></span><br><span class="line">        <span class="comment">//没找到必要信息</span></span><br><span class="line">        $ret[<span class="string">'data'</span>] = <span class="string">'info_not_found'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 退出下正方吧</span></span><br><span class="line">    zfLogout();</span><br><span class="line">    curl_close($ch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析个人页面信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $html_raw 解析的源码，默认给定是xsgrxx页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|bool 是否解析成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseZfInfo</span><span class="params">($html_raw)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $html = <span class="keyword">new</span> simple_html_dom();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 学生个人信息页面</span></span><br><span class="line">    $xsgrxx = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'gender'</span> =&gt; <span class="string">'#lbl_xb'</span>, <span class="comment">//性别</span></span><br><span class="line">        <span class="string">'stuid'</span> =&gt; <span class="string">'#xh'</span>, <span class="comment">//学号</span></span><br><span class="line">        <span class="string">'realname'</span> =&gt; <span class="string">'#xm'</span>, <span class="comment">//真实姓名</span></span><br><span class="line">        <span class="string">'birthday'</span> =&gt; <span class="string">'#lbl_csrq'</span>, <span class="comment">// 生日</span></span><br><span class="line"><span class="comment">//        'uNation' =&gt; '#lbl_mz', //民族</span></span><br><span class="line">        <span class="string">'major'</span> =&gt; <span class="string">'#lbl_zymc'</span>, <span class="comment">//专业</span></span><br><span class="line">        <span class="string">'academy'</span> =&gt; <span class="string">'#lbl_xy'</span>, <span class="comment">// 学院</span></span><br><span class="line"><span class="comment">//        'uIdnumber' =&gt; '#lbl_sfzh', //身份证号 敏感信息！！不敢存啊</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//论文维护信息页面</span></span><br><span class="line">    $lw_xsxx = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'uStuId'</span> =&gt; <span class="string">'#xh'</span>, <span class="comment">// 学号</span></span><br><span class="line">        <span class="string">'uRealname'</span> =&gt; <span class="string">'#xm'</span>, <span class="comment">// 真实姓名</span></span><br><span class="line">        <span class="string">'uAcademy'</span> =&gt; <span class="string">'#xy'</span>, <span class="comment">// 学院</span></span><br><span class="line">        <span class="string">'uMajor'</span> =&gt; <span class="string">'#zy'</span>, <span class="comment">// 专业</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 用户信息</span></span><br><span class="line">    $userInfo = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择要解析的数据页面，设置dom结构点</span></span><br><span class="line">    $infoDom = $xsgrxx;</span><br><span class="line">    $html-&gt;load($html_raw);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抓取数据，如果有一个为空则表示失败</span></span><br><span class="line">    <span class="keyword">foreach</span>($infoDom <span class="keyword">as</span> $key =&gt; $dom_info)&#123;</span><br><span class="line">        $tmp_fetch = trim($html-&gt;find($dom_info, <span class="number">0</span>)-&gt;plaintext);</span><br><span class="line">        <span class="comment">/* 判断是否满足错误条件 */</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($tmp_fetch))<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        $userInfo[$key] = $tmp_fetch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 清理 */</span></span><br><span class="line">    $html-&gt;clear();</span><br><span class="line">    <span class="keyword">unset</span>($key, $dom_info);</span><br><span class="line">    <span class="keyword">return</span> $userInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单退出下，就当可怜正方，也顺便清理下cookie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zfLogout</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $headerArr = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'Referer: http://自己写正方地址/xs_main.aspx?'</span>,</span><br><span class="line">        <span class="string">'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'ASP_NET_SessionId'</span>]))&#123;</span><br><span class="line">        $headerArr[] = <span class="string">'Cookie: ASP.NET_SessionId='</span>.$_COOKIE[<span class="string">'ASP_NET_SessionId'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, <span class="string">'http://自己写正方地址/logout.aspx'</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);    <span class="comment">//表示需要response header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_NOBODY, <span class="number">0</span>); <span class="comment">//表示需要response body</span></span><br><span class="line"><span class="comment">//    curl_setopt($ch,CURLOPT_PROXY,'127.0.0.1:8888');//设置代理服务器 fiddler debug用的</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER , $headerArr );  <span class="comment">//构造header</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">300</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">    setcookie(<span class="string">'ASP_NET_SessionId'</span>,<span class="string">''</span>,time()<span class="number">-86400</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zfauth_create</span><span class="params">($arr)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> $time, $longip, $uid;</span><br><span class="line">    $arr[<span class="string">'gender'</span>] = $arr[<span class="string">'gender'</span>]==<span class="string">'男'</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    $arr[<span class="string">'uid'</span>] = $uid;</span><br><span class="line">    $arr[<span class="string">'auth_date'</span>] = $time;</span><br><span class="line">    $arr[<span class="string">'auth_ip'</span>] = $longip;</span><br><span class="line">    $r = db_create(<span class="string">'zfauth'</span>,$arr);</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面是我配合xiunobbs写的PHP模拟登陆正方，<strong>不具有普遍性</strong>，如果要单用，请替换个别xiunobbs的函数为PHP原函数。</p>
<p>暂时没有写获取课程表啊 成绩之类啊，这里认证不用搞这些。后面这些功能在写就行了，无非就是解析dom</p>
<p>这里有两个getvcode获取验证码的函数说明下，</p>
<ol>
<li>getZfVCode是会把验证码获取下来存放在本地的，然后显示给前端</li>
<li>getZfVcodeRouter是一个获取验证码的路由，你把它当路由使就行了，就是src指向，对了别忘了在前端加个random</li>
</ol>
<h1 id="正方扩展表"><a href="#正方扩展表" class="headerlink" title="正方扩展表"></a>正方扩展表</h1><p>既然认证成功了就记录下部分信息，后面其他功能中可能会调用，比如自动提醒生日？(#^.^#)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">### 正方认证信息 ###</span><br><span class="line">DROP TABLE IF EXISTS `bbs_zfauth`;</span><br><span class="line">CREATE TABLE `bbs_zfauth` (</span><br><span class="line">  `uid` int(11) unsigned NOT NULL COMMENT &apos;用户编号&apos;,</span><br><span class="line">  `gender` tinyint(1) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;性别&apos;,</span><br><span class="line">  `stuid` int(10) unsigned NOT NULL COMMENT &apos;学号&apos;,</span><br><span class="line">  `realname` char(8) NOT NULL COMMENT &apos;姓名&apos;,</span><br><span class="line">  `birthday` int(8) NOT NULL COMMENT &apos;生日&apos;,</span><br><span class="line">  `major` char(40) NOT NULL COMMENT &apos;专业&apos;,</span><br><span class="line">  `academy` char(16) NOT NULL COMMENT &apos;学院&apos;,</span><br><span class="line">  `auth_date` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;认证时间&apos;,</span><br><span class="line">  `auth_ip` int(11) unsigned NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;认证ip&apos;,</span><br><span class="line">  PRIMARY KEY (`uid`),</span><br><span class="line">  UNIQUE KEY `stuid` (`stuid`)</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<p>这里用uid和bbs的user表做个关联，但是不做外键，在逻辑层实现外间关联就可以了。</p>
<h1 id="完善路由controller层"><a href="#完善路由controller层" class="headerlink" title="完善路由controller层"></a>完善路由controller层</h1><p>func已经完成，view也部分完成，接下来完成逻辑控制层，没多少代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">exit</span>;</span><br><span class="line"><span class="keyword">elseif</span>($action == <span class="string">'zfauth'</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/model/zf.func.php'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($method == <span class="string">'GET'</span>) &#123;</span><br><span class="line">        $active = <span class="string">'zfauth'</span>;</span><br><span class="line">        $header[<span class="string">'title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line">        $header[<span class="string">'mobile_title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line">		<span class="comment">// 验证码的存放位置</span></span><br><span class="line">        $vcodesrc = http_url_path().<span class="string">'/tmp/verifyCode.jpg'</span>;</span><br><span class="line">        <span class="comment">// 判断这个这个路由是不是请求验证码的 命中路由为 ?my-zfauth-vcode.htm </span></span><br><span class="line">        $vcode = param(<span class="number">2</span>,<span class="string">''</span>);</span><br><span class="line">        <span class="keyword">if</span> ( $vcode == <span class="string">'getcode'</span> <span class="keyword">and</span> $ajax)&#123;</span><br><span class="line">            $getStatus = getZfVCode(lang(<span class="string">'zfvcodeurl'</span>), $_COOKIE[<span class="string">'ASP_NET_SessionId'</span>],$conf[<span class="string">'tmp_path'</span>]);</span><br><span class="line"></span><br><span class="line">            xn_message($getStatus ? <span class="number">0</span> : <span class="number">1</span>,$getStatus ? $vcodesrc : lang(<span class="string">'zfgetvcodeerr'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        $result = getZfinit(lang(<span class="string">'zfloginurl'</span>));</span><br><span class="line">        getZfVCode(lang(<span class="string">'zfvcodeurl'</span>), $result[<span class="string">'cookie'</span>],$conf[<span class="string">'tmp_path'</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/view/htm/my_zfauth.htm'</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">elseif</span>($method == <span class="string">'POST'</span> <span class="keyword">and</span> $ajax) &#123;</span><br><span class="line">        $zfusername = _POST(<span class="string">'zfusername'</span>);</span><br><span class="line">        $zfpassword = _POST(<span class="string">'zfpassword'</span>);</span><br><span class="line">        $zfvcode = _POST(<span class="string">'zfvcode'</span>);</span><br><span class="line">        $getinfo = getZfInfo(lang(<span class="string">'zfloginurl'</span>),_POST(<span class="string">'zfusername'</span>),_POST(<span class="string">'zfpassword'</span>),_POST(<span class="string">'zfvcode'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果getinfo状态为失败 就返回给前端错误信息</span></span><br><span class="line">        !$getinfo[<span class="string">'status'</span>] <span class="keyword">AND</span> xn_message(<span class="number">1</span>,$getinfo[<span class="string">'data'</span>]);</span><br><span class="line"></span><br><span class="line">        $r = zfauth_create($getinfo[<span class="string">'data'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果获取信息成功，但是插入数据库失败，可能是有其他问题了</span></span><br><span class="line">        $r===<span class="keyword">false</span> <span class="keyword">AND</span> xn_message(<span class="number">1</span>,lang(<span class="string">'create_failed'</span>));</span><br><span class="line"></span><br><span class="line">        xn_message(<span class="number">0</span>,lang(<span class="string">'zfauthsucc'</span>));</span><br><span class="line"></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：不要对开头的exit太关注，这个文件最后是被hook替换掉的，这个exit会消失的，那为何放在这里？安全处理</p>
</blockquote>
<p>交代下几个函数使用：</p>
<ul>
<li>http_url_path()：获取当前的 URL 路径（不包含文件名和参数）</li>
<li>param()：获取 GET POST COOKIE REQUEST 参数</li>
<li>xn_message()：根据请求的方式，输出不同格式的内容，并且终止会话。如果为 AJAX 请求，则输出 json 格式数据：{code: $code, message: $message}。如果为普通请求，则输出 $message。</li>
</ul>
<p>具体请看 ：<a href="https://www.kancloud.cn/xiuno/xiunophp" target="_blank" rel="noopener">https://www.kancloud.cn/xiuno/xiunophp</a></p>
<h2 id="流程-amp-逻辑"><a href="#流程-amp-逻辑" class="headerlink" title="流程&amp;逻辑"></a>流程&amp;逻辑</h2><p>这个逻辑controller的逻辑简单就是：</p>
<p>先判断进来的请求路由是否为zfauth，然后判断请求方式，</p>
<ul>
<li>如果是GET，再判断是否带vcode参数，<ul>
<li>带vcode参数，就是点击验证码刷新的动作</li>
<li>不带vcode参数，就是访问my-zfauth这个页面，下面就是初始化正方函数和获取验证码函数</li>
</ul>
</li>
<li>如果是POST，就是ajax提交的登陆请求，是在登陆正方了，执行获取信息函数，并插入数据库，中途登陆正方的错误信息都在func中我也做了判断并直接返回给前端了。</li>
</ul>
<h1 id="验证码刷新两个函数的实现"><a href="#验证码刷新两个函数的实现" class="headerlink" title="验证码刷新两个函数的实现"></a>验证码刷新两个函数的实现</h1><h2 id="本地存放形式"><a href="#本地存放形式" class="headerlink" title="本地存放形式"></a>本地存放形式</h2><p>这里先用第一种显示验证码的方式，本地先存放，对应的前端请求代码为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'a[data-active="my-zfauth"]'</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getVcode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $.xget(<span class="string">"&lt;?php echo url('my-zfauth-getvcode');?&gt;"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code, message</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(code == <span class="number">0</span>) &#123;</span><br><span class="line">                $(<span class="string">'#vcode'</span>).attr(<span class="string">'src'</span>,message+<span class="string">'?'</span>+<span class="built_in">Math</span>.random());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(<span class="string">'错误：'</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> jform = $(<span class="string">'#zfform'</span>);</span><br><span class="line">    <span class="keyword">var</span> jsubmit = $(<span class="string">'#submit'</span>);</span><br><span class="line">    jsubmit.on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        jform.reset();</span><br><span class="line">        jsubmit.button(<span class="string">'loading'</span>);</span><br><span class="line">        <span class="keyword">var</span> postdata = jform.serialize();</span><br><span class="line">        $.xpost(jform.attr(<span class="string">'action'</span>), postdata, <span class="function"><span class="keyword">function</span>(<span class="params">code, message</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(code == <span class="number">0</span>) &#123;</span><br><span class="line">                jsubmit.button(message).delay(<span class="number">1000</span>).location(<span class="string">"&lt;?php echo url('my-zfauth');?&gt;"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(xn.is_number(code)) &#123;</span><br><span class="line">                alert(message);</span><br><span class="line">                jsubmit.button(<span class="string">'reset'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                jform.find(<span class="string">'[name="'</span>+code+<span class="string">'"]'</span>).alert(message).focus();</span><br><span class="line">                jsubmit.button(<span class="string">'reset'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样也能正常实现点击验证码会刷新</p>
<p><img alt="vcode.gif" data-src="https://upload-images.jianshu.io/upload_images/14657587-0fb42f1ef1d87c0f.gif?imageMogr2/auto-orient/strip" class="lozad"></p>
<h2 id="直接路由访问"><a href="#直接路由访问" class="headerlink" title="直接路由访问"></a>直接路由访问</h2><p>这种方式代码量特别少，但是我因为 莫名其妙 response头部多一个空行 debug了4个小时，后来才知道 世界上最好的语言 尾部?&gt;闭合后不要有空行，否则包含的时候就戏多了，最好纯文本都不要写闭合标签了！！</p>
<blockquote>
<p>plugin/isk2y_zfauth/view/htm/my_zfauth.htm</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;?php echo url('my-zfauth-getcode')?&gt;"</span> <span class="attr">alt</span>=<span class="string">"正方验证码拉取失败~~"</span> <span class="attr">id</span>=<span class="string">"vcode"</span> <span class="attr">onclick</span>=<span class="string">"this.src+='&amp;'+Math.random();"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个view视图只要这样写就行了</p>
<p>逻辑层为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$vcode === <span class="string">'getcode'</span> <span class="keyword">AND</span> <span class="keyword">exit</span>(getZfVcodeRouter(lang(<span class="string">'zfvcodeurl'</span>)));</span><br></pre></td></tr></table></figure>
<h1 id="设置校内认证组"><a href="#设置校内认证组" class="headerlink" title="设置校内认证组"></a>设置校内认证组</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO bbs_group (`gid`,`name`,`creditsfrom`,`creditsto`,`allowread`,`allowthread`,`allowpost`,`allowattach`,`allowdown`) VALUES (&apos;106&apos;,&apos;校内认证组&apos;,&apos;0&apos;,&apos;0&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;)</span><br></pre></td></tr></table></figure>
<p>既然有认证当然有认证组咯！！~~</p>
<p>这些0和1 分别都是某个权限的真假值。</p>
<p>然后我们在代码里添加逻辑，将认证后的同学加入到这个组别中来</p>
<blockquote>
<p>PS：在板块化权限中，只有对应的组别才能发言和查看等其他功能，所以说认证后的组别会使你有更大权限！！</p>
</blockquote>
<p>继续在<code>hook/my_end.php</code>中加入这行代码。在上面创建完数据并插入之后添加这个代码，使得当前用户加入校内认证组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$arr = <span class="keyword">array</span>(<span class="string">'gid'</span>=&gt;<span class="string">'106'</span>);</span><br><span class="line">$r = user_update($uid,$arr);</span><br><span class="line"></span><br><span class="line">$r===<span class="keyword">false</span> <span class="keyword">AND</span> xn_message(<span class="number">1</span>,lang(<span class="string">'join_group_failed'</span>));</span><br></pre></td></tr></table></figure>
<p>最后清理下session中的变量吧</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 清理session中前面设置的数据</span></span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">'zfview'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">'zf_profileUrl'</span>]);</span><br></pre></td></tr></table></figure>
<h1 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h1><p>plugin/isk2y_zfauth/hook/my_end.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">exit</span>;</span><br><span class="line"><span class="keyword">elseif</span>($action == <span class="string">'zfauth'</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/model/zf.func.php'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($method == <span class="string">'GET'</span>) &#123;</span><br><span class="line"></span><br><span class="line">	    $isauth = db_find_one(<span class="string">'zfauth'</span>,<span class="keyword">array</span>(<span class="string">'uid'</span>=&gt;$uid));</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> ($isauth===<span class="keyword">null</span>)&#123;</span><br><span class="line">            $active = <span class="string">'zfauth'</span>;</span><br><span class="line">            $header[<span class="string">'title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line">            $header[<span class="string">'mobile_title'</span>] = lang(<span class="string">'zfauth'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            $vcode = param(<span class="number">2</span>,<span class="string">''</span>);</span><br><span class="line">            <span class="comment">/* 验证码存放本地形式的逻辑层代码</span></span><br><span class="line"><span class="comment">             * $vcodesrc = http_url_path().'/tmp/verifyCode.jpg';</span></span><br><span class="line"><span class="comment">             * if ( $vcode == 'getcode' and $ajax)&#123;</span></span><br><span class="line"><span class="comment">                $getStatus = getZfVCode(lang('zfvcodeurl'), $_COOKIE['ASP_NET_SessionId'],$conf['tmp_path']);</span></span><br><span class="line"><span class="comment">                xn_message($getStatus ? 0 : 1,$getStatus ? $vcodesrc : lang('zfgetvcodeerr'));</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            <span class="keyword">if</span> ( $vcode == <span class="string">'getcode'</span>)&#123;</span><br><span class="line">                $getStatus = getZfVcodeRouter(lang(<span class="string">'zfvcodeurl'</span>));</span><br><span class="line">                <span class="keyword">exit</span>($getStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//或者可以这样写哦，更简练</span></span><br><span class="line"><span class="comment">//            $vcode === 'getcode' AND exit(getZfVcodeRouter(lang('zfvcodeurl')));</span></span><br><span class="line">            $result = getZfinit(lang(<span class="string">'zfloginurl'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//            如果是本地验证码形式 这行就要打开！！</span></span><br><span class="line"><span class="comment">//            getZfVCode(lang('zfvcodeurl'), $result['cookie'],$conf['tmp_path']);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">include</span> _include(APP_PATH.<span class="string">'plugin/isk2y_zfauth/view/htm/my_zfauth.htm'</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">elseif</span>($method == <span class="string">'POST'</span> <span class="keyword">and</span> $ajax) &#123;</span><br><span class="line">        $zfusername = _POST(<span class="string">'zfusername'</span>);</span><br><span class="line">        $zfpassword = _POST(<span class="string">'zfpassword'</span>);</span><br><span class="line">        $zfvcode = _POST(<span class="string">'zfvcode'</span>);</span><br><span class="line">        $getinfo = getZfInfo(lang(<span class="string">'zfloginurl'</span>),_POST(<span class="string">'zfusername'</span>),_POST(<span class="string">'zfpassword'</span>),_POST(<span class="string">'zfvcode'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果getinfo状态为失败 就返回给前端错误信息</span></span><br><span class="line">        !$getinfo[<span class="string">'status'</span>] <span class="keyword">AND</span> xn_message(<span class="number">1</span>, lang($getinfo[<span class="string">'data'</span>]));</span><br><span class="line"></span><br><span class="line">        $r = zfauth_create($getinfo[<span class="string">'data'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果获取信息成功，但是插入数据库失败，可能是有其他问题了</span></span><br><span class="line">        $r===<span class="keyword">false</span> <span class="keyword">AND</span> xn_message(<span class="number">1</span>,lang(<span class="string">'create_failed'</span>));</span><br><span class="line"></span><br><span class="line">        $arr = <span class="keyword">array</span>(<span class="string">'gid'</span>=&gt;<span class="string">'106'</span>);</span><br><span class="line">        $r = user_update($uid,$arr);</span><br><span class="line"></span><br><span class="line">        $r===<span class="keyword">false</span> <span class="keyword">AND</span> xn_message(<span class="number">1</span>,lang(<span class="string">'join_group_failed'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清理session中前面设置的数据</span></span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">'zfview'</span>]);</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">'zf_profileUrl'</span>]);</span><br><span class="line"></span><br><span class="line">        xn_message(<span class="number">0</span>,lang(<span class="string">'zfauthsucc'</span>));</span><br><span class="line"></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>plugin/isk2y_zfauth/hook/lang_zh_cn_bbs.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&apos;zfauth&apos;=&gt;&apos;正方认证&apos;,</span><br><span class="line">&apos;zfusername&apos;=&gt;&apos;用户名&apos;,</span><br><span class="line">&apos;zfpassword&apos;=&gt;&apos;密码&apos;,</span><br><span class="line">&apos;zfrole&apos;=&gt;&apos;身份&apos;,</span><br><span class="line">&apos;zfrole_student&apos;=&gt;&apos;学生&apos;,</span><br><span class="line">&apos;zfrole_teacher&apos;=&gt;&apos;老师&apos;,</span><br><span class="line">&apos;zfverifycode&apos;=&gt;&apos;验证码&apos;,</span><br><span class="line">&apos;zfloginurl&apos;=&gt;&apos;http://自己写正方地址/default2.aspx&apos;,</span><br><span class="line">&apos;zfvcodeurl&apos;=&gt;&apos;http://自己写正方地址/CheckCode.aspx&apos;,</span><br><span class="line">&apos;zfgetvcodesucc&apos;=&gt;&apos;获取验证码成功&apos;,</span><br><span class="line">&apos;zfgetvcodeerr&apos;=&gt;&apos;获取验证码失败&apos;,</span><br><span class="line">&apos;zfauthing&apos;=&gt;&apos;认证中&apos;,</span><br><span class="line">&apos;open_zf_failed&apos;=&gt;&apos;正方打开失败&apos;,</span><br><span class="line">&apos;info_not_found&apos;=&gt;&apos;信息未找到，你是不是没做班主任评价？&apos;,</span><br><span class="line">&apos;zfauthsucc&apos;=&gt;&apos;认证成功&apos;,</span><br><span class="line">&apos;join_group_failed&apos;=&gt;&apos;加入校内认证组失败&apos;,</span><br></pre></td></tr></table></figure>
<p>最后打包最后放GitHub上。。</p>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-f5358f47629406cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<p>游客等未认证用户 只有这个版块内容</p>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-79c78734322a3146.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<p>认证后用户</p>
<p><img alt="image.png" data-src="https://upload-images.jianshu.io/upload_images/14657587-e6f5ca69e2e69efc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lozad"></p>
<h1 id="总结反思"><a href="#总结反思" class="headerlink" title="总结反思"></a>总结反思</h1><ul>
<li>关于cookie和session的机制有更多的了解了</li>
<li>关于xiunobbs的整个流程机制以及hook和overwrite机制有进一步认识</li>
<li>重新预习PHP，dei！世界上最好的语言！真香</li>
</ul>
<p>由于俺编码coding能力比较弱鸡，还在学习，如果PHP代码写得丑的话，轻喷……</p>
<p>如果有什么问题可以和我交流~~</p>
<p>算是又踏上预习PHP之路了……</p>
<h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><ul>
<li>配合认证相关衍生更多功能</li>
<li>维护一个统一集中数据库，用于后面多平台认证</li>
<li>自动发布新闻内容（插件以肝完！）</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">iSk2y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://isk2y.github.io/2018/12/18/xiunoBBS-plugin-zfauth-note/">http://isk2y.github.io/2018/12/18/xiunoBBS-plugin-zfauth-note/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://isk2y.github.io">iSk2y's Note</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP    </a><a class="post-meta__tags" href="/tags/xiuno-BBS/">xiuno BBS    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/01/04/h5-via-app-share/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>H5唤起APP进行分享的尝试</span></div></a></div><div class="next-post pull-right"><a href="/2018/12/11/Learn-XiunoBBs-01/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>简单解读Xiuno BBS之流程</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/12/11/Learn-XiunoBBs-01/" title="简单解读Xiuno BBS之流程"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png"><div class="relatedPosts_title">简单解读Xiuno BBS之流程</div></a></div><div class="relatedPosts_item"><a href="/2019/01/04/h5-via-app-share/" title="H5唤起APP进行分享的尝试"><img class="relatedPosts_cover lozad" data-src="https://cdn.jsdelivr.net/gh/iSk2y/CDN/blog/img/default_bg.png"><div class="relatedPosts_title">H5唤起APP进行分享的尝试</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5b59f0769ce0bc7e7559',
  clientSecret: 'b75a1a70e7a34193ea434785fe07eaecafd86442',
  repo: 'BlogComments',
  owner: 'iSk2y',
  admin: 'iSk2y',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2019 By iSk2y</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>